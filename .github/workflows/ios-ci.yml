# Intent: Run code quality checks, build, and unit tests for the iOS app in CI with timing instrumentation.
name: iOS CI

on:
  push:
    branches:
      - main
      - feature/**
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality-checks:
    name: Code Quality Checks
    runs-on: macos-26
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        check:
          - name: Markdown Lint
            command: npx markdownlint-cli '**/*.md' --ignore node_modules
          - name: SwiftFormat Check
            command: swiftformat --lint ios/Offload
          - name: SwiftLint
            command: swiftlint lint --strict ios/Offload
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (for markdownlint)
        if: matrix.check.name == 'Markdown Lint'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install SwiftFormat
        if: matrix.check.name == 'SwiftFormat Check'
        run: brew install swiftformat

      - name: Install SwiftLint
        if: matrix.check.name == 'SwiftLint'
        run: brew install swiftlint

      - name: Run ${{ matrix.check.name }}
        run: ${{ matrix.check.command }}

  build:
    name: Build iOS App
    runs-on: macos-26
    needs: quality-checks
    timeout-minutes: 20
    env:
      DERIVED_DATA_PATH: ios/DerivedData
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Restore file timestamps
        uses: chetan/git-restore-mtime-action@v2

      - name: Detect installed Xcodes
        run: |
          set -euo pipefail
          apps=(/Applications/Xcode*.app)
          if [ "${apps[0]}" = "/Applications/Xcode*.app" ]; then
            echo "No Xcode apps found in /Applications."
            exit 1
          fi

          echo "Installed Xcodes:"
          best_path=""
          best_version=""
          for app in "${apps[@]}"; do
            plist="$app/Contents/Info.plist"
            version=$(/usr/libexec/PlistBuddy -c 'Print :CFBundleShortVersionString' "$plist")
            echo "- $app ($version)"
            if [ -z "$best_version" ]; then
              best_version="$version"
              best_path="$app"
              continue
            fi
            newest=$(printf '%s\n%s\n' "$best_version" "$version" | sort -V | tail -n1)
            if [ "$newest" = "$version" ]; then
              best_version="$version"
              best_path="$app"
            fi
          done

          echo "Selected Xcode: $best_path ($best_version)"
          echo "XCODE_PATH=$best_path/Contents/Developer" >> "$GITHUB_ENV"
          echo "DEVELOPER_DIR=$best_path/Contents/Developer" >> "$GITHUB_ENV"
          echo "XCODE_VERSION=$best_version" >> "$GITHUB_ENV"

      - name: Select Xcode version
        run: sudo xcode-select -s "$XCODE_PATH"

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Show Swift version
        run: swift --version

      - name: List available SDKs
        run: xcodebuild -showsdks

      - name: Simulator diagnostics
        run: |
          set -euo pipefail
          xcodebuild -version
          swift --version
          xcrun simctl list runtimes
          xcrun simctl list devicetypes | head -n 100
          xcrun simctl list devices available
          xcrun simctl list | sed -n '/== Devices ==/,$p' | head -n 200

      - name: Allocate simulator
        run: bash scripts/ios/allocate-simulator.sh

      - name: Show build settings (simulator)
        run: |
          set +e
          xcodebuild -project ios/Offload.xcodeproj \
            -scheme offload \
            -sdk iphonesimulator \
            -showBuildSettings > build-settings.txt
          grep -E 'SDKROOT|SUPPORTED_PLATFORMS|SUPPORTED_DEVICE_FAMILY|TARGETED_DEVICE_FAMILY' build-settings.txt || true

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ${{ env.DERIVED_DATA_PATH }}
          key: deriveddata-${{ runner.os }}-xcode${{ env.XCODE_VERSION }}-${{ hashFiles('ios/Offload.xcodeproj/**', 'ios/Offload/**/*.swift') }}
          restore-keys: |
            deriveddata-${{ runner.os }}-xcode${{ env.XCODE_VERSION }}-

      - name: Configure Xcode caching
        run: |
          defaults write com.apple.dt.Xcode IgnoreFileSystemDeviceInodeChanges -bool YES

      - name: Show available destinations
        run: |
          xcodebuild -project ios/Offload.xcodeproj \
            -scheme offload \
            -showdestinations || true

      - name: Build for testing (timed)
        run: |
          set -euo pipefail
          log() { echo "[$(date -u +%Y-%m-%dT%H:%M:%SZ)] $*"; }

          log "Starting build-for-testing (simulator=$SIMULATOR_NAME $SIMULATOR_UDID)"
          start=$(date +%s)

          set -o pipefail && xcodebuild build-for-testing \
            -project ios/Offload.xcodeproj \
            -scheme offload \
            -sdk iphonesimulator \
            -destination "id=$SIMULATOR_UDID" \
            -derivedDataPath "$DERIVED_DATA_PATH" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

          end=$(date +%s)
          log "Completed build-for-testing in $((end - start))s"

  test-unit:
    name: Unit Tests with Coverage
    runs-on: macos-26
    needs: build
    timeout-minutes: 20
    env:
      DERIVED_DATA_PATH: ios/DerivedData
      TEST_RESULT_PATH: ios/TestResults.xcresult
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Restore file timestamps
        uses: chetan/git-restore-mtime-action@v2

      - name: Detect installed Xcodes
        run: |
          set -euo pipefail
          apps=(/Applications/Xcode*.app)
          if [ "${apps[0]}" = "/Applications/Xcode*.app" ]; then
            echo "No Xcode apps found in /Applications."
            exit 1
          fi

          echo "Installed Xcodes:"
          best_path=""
          best_version=""
          for app in "${apps[@]}"; do
            plist="$app/Contents/Info.plist"
            version=$(/usr/libexec/PlistBuddy -c 'Print :CFBundleShortVersionString' "$plist")
            echo "- $app ($version)"
            if [ -z "$best_version" ]; then
              best_version="$version"
              best_path="$app"
              continue
            fi
            newest=$(printf '%s\n%s\n' "$best_version" "$version" | sort -V | tail -n1)
            if [ "$newest" = "$version" ]; then
              best_version="$version"
              best_path="$app"
            fi
          done

          echo "Selected Xcode: $best_path ($best_version)"
          echo "XCODE_PATH=$best_path/Contents/Developer" >> "$GITHUB_ENV"
          echo "DEVELOPER_DIR=$best_path/Contents/Developer" >> "$GITHUB_ENV"
          echo "XCODE_VERSION=$best_version" >> "$GITHUB_ENV"

      - name: Select Xcode version
        run: sudo xcode-select -s "$XCODE_PATH"

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Show Swift version
        run: swift --version

      - name: Simulator diagnostics
        run: |
          set -euo pipefail
          xcodebuild -version
          swift --version
          xcrun simctl list runtimes
          xcrun simctl list devicetypes | head -n 100
          xcrun simctl list devices available
          xcrun simctl list | sed -n '/== Devices ==/,$p' | head -n 200

      - name: Allocate simulator
        run: bash scripts/ios/allocate-simulator.sh

      - name: Log available simulators
        run: |
          echo "[$(date -u +%Y-%m-%dT%H:%M:%SZ)] Available iPhone simulators:"
          xcrun simctl list devices available iPhone || true

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ${{ env.DERIVED_DATA_PATH }}
          key: deriveddata-${{ runner.os }}-xcode${{ env.XCODE_VERSION }}-${{ hashFiles('ios/Offload.xcodeproj/**', 'ios/Offload/**/*.swift') }}
          restore-keys: |
            deriveddata-${{ runner.os }}-xcode${{ env.XCODE_VERSION }}-

      - name: Configure Xcode caching
        run: |
          defaults write com.apple.dt.Xcode IgnoreFileSystemDeviceInodeChanges -bool YES

      # Exit 117 has been observed here when CoreSimulator services are stuck; the boot script now retries with shutdown/erase and prints simulator inventories for RCA.
      - name: Boot simulator (timed)
        run: bash scripts/ios/boot-simulator.sh

      - name: Run unit tests
        run: |
          set -euo pipefail
          log() { echo "[$(date -u +%Y-%m-%dT%H:%M:%SZ)] $*"; }

          if [ ! -d "$DERIVED_DATA_PATH" ]; then
              log "DerivedData missing; running build-for-testing fallback"
              xcodebuild build-for-testing \
                -project ios/Offload.xcodeproj \
                -scheme offload \
                -sdk iphonesimulator \
                -destination "id=$SIMULATOR_UDID" \
                -derivedDataPath "$DERIVED_DATA_PATH" \
                CODE_SIGN_IDENTITY="" \
                CODE_SIGNING_REQUIRED=NO \
                CODE_SIGNING_ALLOWED=NO
          fi

          watchdog() {
            while true; do
              sleep 60
              log "watchdog: xcodebuild still running"
              xcrun simctl list devices | grep "$SIMULATOR_UDID" || true
            done
          }

          log "Starting tests without rebuild on simulator $SIMULATOR_NAME"
          start=$(date +%s)
          watchdog &
          watchdog_pid=$!
          trap 'kill "$watchdog_pid" || true' EXIT

          set -o pipefail && xcodebuild test-without-building \
            -project ios/Offload.xcodeproj \
            -scheme offload \
            -sdk iphonesimulator \
            -destination "id=$SIMULATOR_UDID" \
            -derivedDataPath "$DERIVED_DATA_PATH" \
            -resultBundlePath "$TEST_RESULT_PATH" \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -destination-timeout 120

          end=$(date +%s)
          log "Completed tests in $((end - start))s"

      - name: Inspect test result bundle
        id: inspect-xcresult
        if: always()
        run: |
          set -euo pipefail
          if [ -d "$TEST_RESULT_PATH" ]; then
              echo "bundle_present=true" >> "$GITHUB_OUTPUT"
              du -sh "$TEST_RESULT_PATH" || true
              exit 0
          fi

          echo "bundle_present=false" >> "$GITHUB_OUTPUT"
          echo "::error::Test result bundle missing at $TEST_RESULT_PATH. Simulator boot likely failed before tests ran; collecting diagnostics."

          echo "== Post-failure simulator diagnostics =="
          xcrun simctl list devices available || true
          xcrun simctl list runtimes || true
          if [ -n "${SIMULATOR_UDID:-}" ]; then
              xcrun simctl list devices "$SIMULATOR_UDID" || true
              xcrun simctl getenv "$SIMULATOR_UDID" SIMULATOR_DEVICE_NAME || true
              xcrun simctl spawn "$SIMULATOR_UDID" launchctl print system || true
          fi

          exit 1

      - name: Check coverage threshold
        run: |
          if [ "${{ steps.inspect-xcresult.outputs.bundle_present }}" != "true" ]; then
              echo "::error::Cannot check coverage because $TEST_RESULT_PATH is missing. Simulator boot failures prevent xcodebuild from writing results; see diagnostics above."
              exit 1
          fi
          bash scripts/ios/check-coverage.sh "$TEST_RESULT_PATH"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: ${{ env.TEST_RESULT_PATH }}
          if-no-files-found: warn
          retention-days: 30

      - name: Generate coverage report
        if: always()
        run: |
          if [ "${{ steps.inspect-xcresult.outputs.bundle_present }}" != "true" ]; then
              echo "Skipping coverage report generation because $TEST_RESULT_PATH is missing."
              exit 0
          fi
          xcrun xccov view --report --json "$TEST_RESULT_PATH" > coverage-report.json

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage-report.json
          if-no-files-found: warn
          retention-days: 30

  # UI Tests - Disabled initially
  # Uncomment when ready to enable UI tests
  # test-ui:
  #   name: UI Tests
  #   runs-on: macos-15
  #   needs: test-unit
  #   timeout-minutes: 20
  #   env:
  #     XCODE_PATH: /Applications/Xcode_16.0.app/Contents/Developer
  #     DERIVED_DATA_PATH: ios/DerivedData
  #     UI_TEST_RESULT_PATH: ios/UITestResults.xcresult
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #
  #     - name: Restore file timestamps
  #       uses: chetan/git-restore-mtime-action@v2
  #
  #     - name: Select Xcode version
  #       run: sudo xcode-select -s "$XCODE_PATH"
  #
  #     - name: Setup simulator
  #       run: bash scripts/ios/setup-simulator.sh
  #
  #     - name: Cache DerivedData
  #       uses: actions/cache@v4
  #       with:
  #         path: ${{ env.DERIVED_DATA_PATH }}
  #         key: deriveddata-${{ runner.os }}-xcode16-${{ hashFiles('ios/Offload.xcodeproj/**', 'ios/Offload/**/*.swift') }}
  #         restore-keys: |
  #           deriveddata-${{ runner.os }}-xcode16-
  #
  #     - name: Configure Xcode caching
  #       run: |
  #         defaults write com.apple.dt.Xcode IgnoreFileSystemDeviceInodeChanges -bool YES
  #
  #     - name: Run UI tests
  #       run: |
  #         xcodebuild test \
  #           -project ios/Offload.xcodeproj \
  #           -scheme offload \
  #           -destination 'platform=iOS Simulator,name=iPhone 16 Pro,OS=latest' \
  #           -derivedDataPath "$DERIVED_DATA_PATH" \
  #           -resultBundlePath "$UI_TEST_RESULT_PATH" \
  #           -only-testing:offloadUITests \
  #           CODE_SIGN_IDENTITY="" \
  #           CODE_SIGNING_REQUIRED=NO \
  #           CODE_SIGNING_ALLOWED=NO \
  #           | xcpretty || exit 1
  #
  #     - name: Upload UI test results
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: ui-test-results
  #         path: ${{ env.UI_TEST_RESULT_PATH }}
  #         retention-days: 30
